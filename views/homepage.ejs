<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   

    <link href="/kiva_style.css" rel="stylesheet" type="text/css">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="//code.jquery.com/jquery-1.9.1.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    

    <title>Submit an Application</title>
    <script>     

    var load_review = function(volunteer) {
        $('#user-header').append(
            "<h2>" + volunteer["first_name"] + "</h2>" +
            "<h2>" + "Points: " + volunteer.num_points + "</h2>"
            );
        if(volunteer.current_review == null) {
            //pulls new review  
            $.getJSON('/volunteer/get_min_reviewed_application', function(data) {
                if(data.data !== "none") {
                        $('#review').append(
                            "<div id='review-display'>" +
                            "<h2>" + data["organization_name"] + "</h2>" +
                            "<p>" + data["description"] + "</p>" +
                            "<a href='" + data["organization_url"] + "' id='homepage-button' class='btn btn-primary'>Homepage</a>" + 
                            "<p><h4>Reviews to date: " + data["num_reviews"] + "</h4></p>" +
                            "<p><h2>Help get this application on track!</h2><p>" +
                            "<form method='POST' action='/review/create/" + data["_id"] + "'>" + 
                            "<input type='submit' id='review-button' class='btn btn-primary' value='Create Review'>" + 
                            "</form>" +
                            "</div>"
                            );
                } else {
                      $('#review').append(
                         "<p> There are currently no reviews for you to complete. </p>"
                         )
                }
            });
            } else {
                $('#review').append(
                   "<p> You have one review pending. </p>" +
                   
                   "<a href='/review/edit/" + volunteer.current_review + "' id='review-button' class='btn btn-primary'>Complete Current Review</a>" +

                   "</div>"
                    );
             };
     };

    var load_completed_apps = function() {
        $.getJSON('/volunteer/get_completed_applications', function(completed_apps) {
            $('#completed-table table').append("<tr>" + 
                "<th>" + "Organization" + "</th>" +
                "<th>" + "Status" + "</th>" +
                "<th>" + "Date Started" + "</th>" +
                "<th>" + "Date Submitted" + "</th>" +
                "</tr>");
            $.each(completed_apps, function(index, value) {
                $.getJSON("/review/organization_data/" + value.organization_id, function(organization) {  
                    
                    var start = new Date(value.date_review_started);
                    var submitted = new Date(value.date_review_submitted);
                    var status = "ShortListed";
                    if (!organization.shortlisted) {
                        status = " - ";
                    }
                    $('#completed-table table').append("<tr>" + 
                        "<td>" + organization.organization_name + "</td>" +
                        "<td>" + status + "</td>" +
                        "<td>" + start.toLocaleDateString() + "</td>" +
                        "<td>" + submitted.toLocaleDateString() + "</td>" +
                        "</tr>");
                });
            });
        }); 
    }

    var load_achievements = function() {
    $.getJSON('/volunteer/get_achievements', function(achievs) {
        console.log(achievs);
        $('#achievs table').append("<tr>" + 
            "<th>" + "Text" + "</th>" +
            "<th>" + "Points" + "</th>" +
            "<th>" + "Date" + "</th>" +
            "</tr>");
        $.each(achievs, function(index, value) {
            console.log(value);
            console.log(value.achievement_text);
            var date = new Date(value.date);
            $('#achievs table').append("<tr>" + 
                "<td>" + value.achievement_text + "</td>" +
                "<td>" + value.points + "</td>" +
                "<td>" + date.toLocaleDateString() + "</td>" +
                "</tr>");
            });
        });
    }

    $( document ).ready(function() {
        $.getJSON('/volunteer/load', function(volunteer) {
            if (!volunteer.finished_training) {
                $('#training').append($('<a>')
                                        .attr('href', '/volunteer/training')
                                        .html('Get training first'));
            }
            else {
                load_achievements();
                load_review(volunteer);
                load_completed_apps();
            }
        });
    });

    </script>

  </head>

<body>
    <div id="wrapper">


    <% include banner %>   

    <style>
        h2, h4{
            text-align: center;
            margin: 5;
            color: green;
        }
    </style>

    <p><div id="user-header"></div></p>

    <div id="training"></div>
    <div id="row">
            <div id="achievs" class="col-md-4"><table class='table table-striped'></table></div>
            <div id="review" class="col-md-4"></div>
            <div id="completed-table" class="col-md-4"><table class='table table-striped'></table></div>
    </div>
    


    <% include footer %>   
    </div>


  </body>


  </html>